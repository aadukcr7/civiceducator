<%- include('partials/header', { title: 'Dashboard' }) %>

<main class="flex-grow-1">
  <div class="container py-5">
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-2">
      <h1 class="mb-0">Welcome, <%= session.username %>!</h1>
      <a href="/profile" class="btn btn-outline-primary">View Profile</a>
    </div>

    <!-- Statistics Cards -->
    <div class="row g-4 mb-5">
      <div class="col-md-3">
        <div class="stat-card">
          <div class="stat-icon"><i class="bi bi-graph-up"></i></div>
          <div class="stat-content">
            <h6>Progress</h6>
            <h3 id="progressPercent">0%</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stat-card">
          <div class="stat-icon"><i class="bi bi-check2-circle"></i></div>
          <div class="stat-content">
            <h6>Completed</h6>
            <h3 id="completedCount">0</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stat-card">
          <div class="stat-icon"><i class="bi bi-bar-chart"></i></div>
          <div class="stat-content">
            <h6>Average Score</h6>
            <h3 id="avgScore">--</h3>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stat-card">
          <div class="stat-icon"><i class="bi bi-bullseye"></i></div>
          <div class="stat-content">
            <h6>Total Levels</h6>
            <h3 id="totalLevels">6</h3>
          </div>
        </div>
      </div>
    </div>

    <!-- Progress Bar -->
    <div class="mb-5">
      <h4>Overall Progress</h4>
      <div class="progress" style="height: 30px;">
        <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%">
          <span id="progressText">0%</span>
        </div>
      </div>
    </div>

    <!-- Learner Analytics -->
    <h4 class="mb-3">Learner Analytics</h4>
    <div class="row g-4 mb-5">
      <div class="col-lg-4">
        <div class="card h-100">
          <div class="card-body">
            <h5 class="card-title">Strengths</h5>
            <ul id="strengthsList" class="mb-0 ps-3"></ul>
          </div>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="card h-100">
          <div class="card-body">
            <h5 class="card-title">Weak Areas</h5>
            <ul id="weakAreasList" class="mb-0 ps-3"></ul>
          </div>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="card h-100">
          <div class="card-body">
            <h5 class="card-title">Recommended Next Lesson</h5>
            <p id="recommendedLesson" class="mb-0 text-muted">No recommendation yet.</p>
          </div>
        </div>
      </div>
    </div>

    <h4 class="mb-3">Per-Topic Performance</h4>
    <div id="topicAnalytics" class="row g-3 mb-5"></div>

  </div>
</main>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  const listOrEmpty = (items, formatter) => {
    if (!items || items.length === 0) {
      return '<li class="text-muted">Not enough quiz data yet.</li>';
    }
    return items.map(formatter).join('');
  };

  const renderAnalytics = (analytics) => {
    const strengthsList = document.getElementById('strengthsList');
    const weakAreasList = document.getElementById('weakAreasList');
    const recommendedLesson = document.getElementById('recommendedLesson');
    const topicAnalytics = document.getElementById('topicAnalytics');

    strengthsList.innerHTML = listOrEmpty(analytics?.strengths, (item) =>
      `<li><strong>${item.topic}</strong> — ${item.avgScore}% avg</li>`
    );

    weakAreasList.innerHTML = listOrEmpty(analytics?.weakAreas, (item) =>
      `<li><strong>${item.topic}</strong> — ${item.avgScore}% avg</li>`
    );

    if (analytics?.recommendedNextLesson) {
      const recommendation = analytics.recommendedNextLesson;
      recommendedLesson.innerHTML = `
        <strong>${recommendation.levelTitle}</strong><br>
        ${recommendation.lessonTitle}<br>
        <small>${recommendation.reason}</small>
      `;
    } else {
      recommendedLesson.textContent = 'Complete at least one quiz to get a personalized recommendation.';
    }

    topicAnalytics.innerHTML = '';
    if (!analytics?.topicStats || analytics.topicStats.length === 0) {
      topicAnalytics.innerHTML = '<div class="col-12"><div class="alert alert-info mb-0">No topic analytics available yet.</div></div>';
      return;
    }

    analytics.topicStats.forEach((topic) => {
      const card = document.createElement('div');
      card.className = 'col-lg-4';
      card.innerHTML = `
        <div class="card h-100">
          <div class="card-body">
            <h6 class="card-title mb-2">${topic.topic}</h6>
            <p class="mb-1"><strong>Attempts:</strong> ${topic.attempts}</p>
            <p class="mb-1"><strong>Average Score:</strong> ${topic.avgScore !== null ? topic.avgScore + '%' : '--'}</p>
            <p class="mb-1"><strong>Avg Time/Question:</strong> ${topic.avgSecondsPerQuestion !== null ? topic.avgSecondsPerQuestion + 's' : '--'}</p>
            <p class="mb-0"><strong>Next Difficulty:</strong> ${topic.nextDifficultyLabel}</p>
          </div>
        </div>
      `;
      topicAnalytics.appendChild(card);
    });
  };

  try {
    const response = await fetch('/levels/data/dashboard');
    const data = await response.json();

    // Update stats
    document.getElementById('progressPercent').textContent = data.stats.progressPercentage + '%';
    document.getElementById('completedCount').textContent = data.stats.completedCount;
    document.getElementById('avgScore').textContent = data.stats.avgScore > 0 ? data.stats.avgScore + '%' : '--';
    document.getElementById('totalLevels').textContent = data.stats.totalLevels;

    // Update progress bar
    const progressPercent = data.stats.progressPercentage;
    document.getElementById('progressBar').style.width = progressPercent + '%';
    document.getElementById('progressText').textContent = progressPercent + '%';

    renderAnalytics(data.analytics);

  } catch (error) {
    console.error('Error loading dashboard:', error);
  }
});
</script>

<%- include('partials/footer') %>
