<%- include('partials/header', { title: level.title }) %>

<main class="flex-grow-1">
  <div class="container py-5">
    <div class="row">
      <!-- Sidebar Navigation -->
      <div class="col-lg-3">
        <div class="lesson-sidebar">
          <h5 class="mb-3"><%= level.title %></h5>
          <% if (lessons && lessons.length > 0) { %>
            <div class="lesson-sidebar-controls mb-3">
              <div class="input-group input-group-sm mb-2">
                <label class="input-group-text" for="lessonJump">Jump</label>
                <select id="lessonJump" class="form-select" aria-label="Jump to lesson">
                  <option value="">Select lesson...</option>
                  <% lessons.forEach((lesson, index) => { %>
                    <option value="lesson-<%= lesson.id %>">Lesson <%= index + 1 %>: <%= lesson.title %></option>
                  <% }); %>
                </select>
              </div>
              <div class="d-flex gap-2">
                <button type="button" class="btn btn-outline-primary btn-sm flex-fill lesson-scroll-btn" data-scroll-direction="up">
                  <i class="bi bi-arrow-up"></i> Up
                </button>
                <button type="button" class="btn btn-outline-primary btn-sm flex-fill lesson-scroll-btn" data-scroll-direction="down">
                  <i class="bi bi-arrow-down"></i> Down
                </button>
              </div>
            </div>
          <% } %>
          <div class="lesson-list">
            <% if (lessons && lessons.length > 0) { %>
              <% lessons.forEach((lesson, index) => { %>
                <a href="#lesson-<%= lesson.id %>" class="lesson-item <%= index === 0 ? 'active-lesson' : '' %>">
                  <span class="lesson-number"><%= index + 1 %></span>
                  <span class="lesson-title"><%= lesson.title %></span>
                </a>
              <% }); %>
            <% } %>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="col-lg-9">
        <!-- Lessons Section -->
        <% if (lessons && lessons.length > 0) { %>
          <% lessons.forEach((lesson, index) => { %>
            <div class="lesson-card" id="lesson-<%= lesson.id %>">
              <h3><%= lesson.title %></h3>
              <p class="lesson-number">Lesson <%= index + 1 %> of <%= lessons.length %></p>
              <div class="lesson-content">
                <p><%= lesson.content %></p>
              </div>
              <% if (lesson.keyPoints && lesson.keyPoints.length > 0) { %>
                <div class="key-points">
                  <h5>üìå Key Points:</h5>
                  <ul>
                    <% lesson.keyPoints.forEach(point => { %>
                      <li><%= point %></li>
                    <% }); %>
                  </ul>
                </div>
              <% } %>
              <% if (lesson.articles) { %>
                <p class="text-muted"><strong>Constitutional Reference:</strong> <%= lesson.articles %></p>
              <% } %>
              <% if (lesson.helpline) { %>
                <p class="alert alert-info"><strong>üìû Important Helpline:</strong> <%= lesson.helpline %></p>
              <% } %>
            </div>
          <% }); %>
        <% } else { %>
          <div class="lesson-card">
            <p>No lessons available for this level.</p>
          </div>
        <% } %>

        <!-- Quiz Section -->
        <div class="quiz-section">
          <h3>Take the Quiz</h3>
          <p class="text-muted">Answer all questions. You need 70% to pass.</p>
          <% if (adaptiveDifficulty) { %>
            <p class="text-muted mb-3">
              <strong>Adaptive Mode:</strong> Your next quiz difficulty is set to <%= adaptiveDifficulty %> based on recent performance and completion speed.
            </p>
          <% } %>
          
          <form method="POST" action="/levels/<%= level.id %>/quiz" id="quizForm">
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
            <% if (level.quiz && level.quiz.length > 0) { %>
              <% level.quiz.forEach((question, qIndex) => { %>
                <div class="quiz-question">
                  <h5><strong><%= qIndex + 1 %>.</strong> <%= question.question %></h5>
                  <% question.options.forEach((option, oIndex) => { %>
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="answers[q<%= question.id %>]" 
                        id="q<%= question.id %>_<%= oIndex %>" value="<%= oIndex %>" required>
                      <label class="form-check-label" for="q<%= question.id %>_<%= oIndex %>">
                        <%= option %>
                      </label>
                    </div>
                  <% }); %>
                </div>
              <% }); %>
              
              <button type="submit" class="btn btn-primary btn-lg mt-4">Submit Quiz</button>
            <% } else { %>
              <p class="alert alert-warning">No quiz available for this level yet.</p>
            <% } %>
          </form>
        </div>

        <!-- Progress Info -->
        <% if (progress && progress.completed) { %>
          <div class="alert alert-success mt-4">
            <strong>‚úì You have completed this level!</strong><br>
            Score: <%= progress.score %>% | Date: <%= new Date(progress.completed_at).toLocaleDateString() %>
          </div>
        <% } %>
      </div>
    </div>

    <!-- Back Button -->
    <div class="mt-4">
      <a href="/levels" class="btn btn-outline-secondary">‚Üê Back to Levels</a>
    </div>
  </div>
</main>

<%- include('partials/footer') %>
