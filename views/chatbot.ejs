<%- include('partials/header', { title: 'Civic Assistant' }) %>

<main class="flex-grow-1">
  <div class="container py-5">
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-2">
      <div>
        <h1 class="mb-1">Civic Assistant</h1>
        <p class="text-muted mb-0">Ask anything from any level lesson, and get grounded answers from your curriculum.</p>
      </div>
      <a href="/levels" class="btn btn-outline-secondary">← Back to Levels</a>
    </div>

    <div class="card border-0 shadow-sm mb-4">
      <div class="card-body">
        <h5 class="card-title">Ask your question</h5>
        <form id="chatbotForm" class="mt-3">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <textarea
            id="chatQuestion"
            name="question"
            class="form-control mb-3"
            rows="3"
            placeholder="Example: What are the fundamental rights and where are they mentioned?"
            required
          ></textarea>
          <div class="d-flex gap-2">
            <button id="askButton" type="submit" class="btn btn-primary">Ask Assistant</button>
            <button id="clearButton" type="button" class="btn btn-outline-secondary">Clear</button>
          </div>
        </form>
      </div>
    </div>

    <div id="chatResult" class="card border-0 shadow-sm d-none">
      <div class="card-body">
        <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
          <h5 class="card-title mb-0">Answer</h5>
          <span id="confidenceBadge" class="badge text-bg-light border"></span>
          <span id="modeBadge" class="badge"></span>
        </div>

        <p id="answerText" class="mb-4" style="white-space: pre-line;"></p>

        <h6>Sources</h6>
        <ul id="sourceList" class="mb-0"></ul>

        <div class="mt-3">
          <h6>Citations</h6>
          <ul id="citationList" class="mb-0"></ul>
        </div>
      </div>
    </div>
  </div>
</main>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('chatbotForm');
  const questionInput = document.getElementById('chatQuestion');
  const askButton = document.getElementById('askButton');
  const clearButton = document.getElementById('clearButton');

  const resultCard = document.getElementById('chatResult');
  const answerText = document.getElementById('answerText');
  const sourceList = document.getElementById('sourceList');
  const citationList = document.getElementById('citationList');
  const confidenceBadge = document.getElementById('confidenceBadge');
  const modeBadge = document.getElementById('modeBadge');

  function renderResult(payload) {
    answerText.textContent = payload.answer || 'No answer available.';

    const confidence = Number(payload.confidence || 0);
    confidenceBadge.textContent = `Confidence: ${Math.round(confidence * 100)}%`;

    if (payload.isFallback) {
      modeBadge.className = 'badge bg-warning text-dark';
      modeBadge.textContent = "Fallback: I don't know";
    } else {
      modeBadge.className = 'badge bg-success';
      modeBadge.textContent = 'Grounded answer';
    }

    sourceList.innerHTML = '';
    if (Array.isArray(payload.sources) && payload.sources.length > 0) {
      payload.sources.forEach((source) => {
        const li = document.createElement('li');
        li.textContent = `${source.levelTitle} — ${source.lessonTitle}`;
        sourceList.appendChild(li);
      });
    } else {
      const li = document.createElement('li');
      li.className = 'text-muted';
      li.textContent = 'No matching lesson source found.';
      sourceList.appendChild(li);
    }

    citationList.innerHTML = '';
    if (Array.isArray(payload.citations) && payload.citations.length > 0) {
      payload.citations.forEach((citation) => {
        const li = document.createElement('li');
        const snippetText = Array.isArray(citation.snippets) && citation.snippets.length > 0
          ? ` — ${citation.snippets[0]}`
          : '';
        li.textContent = `${citation.label} ${citation.levelTitle} — ${citation.lessonTitle}${snippetText}`;
        citationList.appendChild(li);
      });
    } else {
      const li = document.createElement('li');
      li.className = 'text-muted';
      li.textContent = 'No citation available.';
      citationList.appendChild(li);
    }

    resultCard.classList.remove('d-none');
  }

  form.addEventListener('submit', async (event) => {
    event.preventDefault();

    const question = questionInput.value.trim();
    const csrf = form.querySelector('input[name="_csrf"]').value;
    if (!question) return;

    askButton.disabled = true;
    askButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Answering...';

    try {
      const response = await fetch('/chatbot/ask', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ question, _csrf: csrf }),
      });

      const payload = await response.json();
      renderResult(payload);
    } catch (err) {
      renderResult({
        answer: 'Unable to answer at this time. Please try again.',
        confidence: 0,
        sources: [],
        citations: [],
        isFallback: true,
      });
    } finally {
      askButton.disabled = false;
      askButton.textContent = 'Ask Assistant';
    }
  });

  clearButton.addEventListener('click', () => {
    questionInput.value = '';
    resultCard.classList.add('d-none');
    questionInput.focus();
  });
});
</script>

<%- include('partials/footer') %>
